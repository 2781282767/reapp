#!/usr/bin/env node

var Program = require('commander');
var colors = require('colors');
var server = require('reapp-server');
var pack = require('reapp-pack');
var makeLayout = require('reapp-pack/lib/makeLayout');
var webpackServer = require('reapp-pack/webpackServer');
var checkIsReapp = require('./lib/checkIsReapp');

var dir = process.cwd();

Program
  .option('-d, --debug', 'output extra information for debugging')
  .option('-p, --port [number]', 'specify a port [number]', 3010)
  .parse(process.argv);

// debug
if (Program.debug) {
  console.log('CLI received opts:'.blue.bold);
  console.log(Program);
  console.log();
}

checkIsReapp(dir);

// webpack port is next one up
var wport = Program.port + 1;

// find config
var config = require(dir + '/config/run.config.js');

// default config
if (!config) {
  var runConfig = require('reapp-pack/config/run.js');
  config = runConfig({
    dir: dir,
    port: wport,
    linkModules: true,
    debug: Program.debug
  });
}

// html template
var layout = makeLayout({
  template: dir + '/assets/layout.html',
  port: wport,
  scripts: Object.keys(config.entry)
});

// express
server({
  dir: dir,
  template: layout,
  debug: Program.debug,
  port: Program.port
});

// webpack-dev-server
webpackServer(config, {
  dir: dir,
  hot: true,
  debug: Program.debug,
  port: wport
});